/dts-v1/;
/plugin/;

#include "dt-bindings/gpio/gpio.h"
#include <dt-bindings/input/input.h>
#include <dt-bindings/interrupt-controller/irq.h>

/ {
	compatible = "brcm,bcm2712";
	
	fragment@0 {
		target-path="/";
		__overlay__ {
			hardware = "reComputer R22";
		};
	};
	
	fragment@1 {
		target = <&i2c6>;
		__overlay__ {
			status = "okay";
			pinctrl-0 = <&rp1_i2c6_38_39>;
			pinctrl-names = "default";
			clock-frequency = <100000>;
			#address-cells = <1>;
			#size-cells = <0>;
			
			tlv320aic3104: tlv320aic3104@18 {
				#sound-dai-cells = <0>;
				compatible = "ti,tlv320aic3104";
				reg = <0x18>;
				gpio-reset = <&pca9535_1 14 GPIO_ACTIVE_LOW>;
				ai3x-micbias-vg = <2>;// set MICBIAS to 2.5v
			};
			
			eeprom@50 {
				compatible = "atmel,24c32";
				reg = <0x50>;
				wp-gpios = <&pca9535_1 4 0>;
			};
			
			pcf8563@51 {
				compatible = "nxp,pcf8563";
				reg = <0x51>;
				reset-source;
				/* 0 = 4096Hz, 1 = 64Hz, 2 = 1Hz, 3 = 1/60Hz */
				timer-frequency = <0x02>;
				/* Timeout count, max 255 min 2*/
				default-timeout =  <120>;
				min-hw-heartbeat-ms = <2000>;
			};
			
			atecc608a@60 {
				compatible = "sferalabs,atecc";
				reg = <0x60>;
				status = "okay";
			};
		};
	};
	
	fragment@2 {
		target = <&i2c1>;
		__overlay__ {
			status = "okay";
			pinctrl-0 = <&rp1_i2c1_10_11>;
			pinctrl-names = "default";
			clock-frequency = <400000>;
			#address-cells = <1>;
			#size-cells = <0>;
			
			pca9535_1: pca@21 {
				compatible = "nxp,pca9535";
				reg = <0x21>;
				status = "okay";
				
				gpio-controller;
				#gpio-cells = <2>;
				interrupt-controller;
				#interrupt-cells = <2>;

				interrupt-parent = <&gpio>;
				interrupts = <26 IRQ_TYPE_LEVEL_LOW>;

				gpio-line-names =
				"PSE_PG",
				"PSE_INTB",
				"TPM_RST",
				"Buzzer_EN",
				"EEP_WP",
				"USER_LED_B",
				"USER_LED_G",
				"USER_LED_R",
				"LoRaWAN_SX1302_RST",
				"LoRaWAN_SX1262_RST",
				"LoRaWAN_SX1262_CS",
				"RS485_POWER_EN",
				"CH344_RST",
				"PSE_PWR_EN",
				"Codec_RST",
				"LAN7800_RST"
				;
				
				PSE_PG {
					gpios = <&pca9535_1 0 0>;
					output-high;
					line-name = "PSE_PG";
				};
				
				PSE_INTB {
					gpios = <&pca9535_1 1 0>;
					output-high;
					line-name = "PSE_INTB";
				};
				
				TPM_RST {
					gpios = <&pca9535_1 2 0>;
					output-high;
					line-name = "TPM_RST";
				};
				
				Buzzer_EN {
					gpios = <&pca9535_1 3 0>;
					output-high;
					line-name = "Buzzer_EN";
				};
				
				EEP_WP {
					gpios = <&pca9535_1 4 0>;
					output-high;
					line-name = "EEP_WP";
				};
				
				USER_LED_B {
					gpios = <&pca9535_1 5 0>;
					output-high;
					line-name = "USER_LED_B";
				};
				
				USER_LED_G {
					gpios = <&pca9535_1 6 0>;
					output-high;
					line-name = "USER_LED_G";
				};
				
				USER_LED_R {
					gpios = <&pca9535_1 7 0>;
					output-high;
					line-name = "USER_LED_R";
				};
				
				LoRaWAN_SX1302_RST {
					gpios = <&pca9535_1 8 0>;
					output-low;
					line-name = "LoRaWAN_SX1302_RST";
				};
				
				LoRaWAN_SX1262_RST {
					gpios = <&pca9535_1 9 0>;
					output-low;
					line-name = "LoRaWAN_SX1262_RST";
				};
				
				LoRaWAN_SX1262_CS {
					gpios = <&pca9535_1 10 0>;
					output-low;
					line-name = "LoRaWAN_SX1262_CS";
				};
				
				RS485_POWER_EN {
					gpios = <&pca9535_1 11 0>;
					output-low;
					line-name = "RS485_POWER_EN";
				};
				
				CH344_RST {
					gpios = <&pca9535_1 12 0>;
					output-low;
					line-name = "CH344_RST";
				};
				
				PSE_PWR_EN {
					gpios = <&pca9535_1 13 0>;
					output-low;
					line-name = "PSE_PWR_EN";
				};
				
				Codec_RST {
					gpios = <&pca9535_1 14 0>;
					
					output-high;
					line-name = "Codec_RST";
				};
				
				LAN7800_RST {
					gpios = <&pca9535_1 15 0>;
					output-low;
					line-name = "LAN7800_RST";
				};
			};
			
			pca9535_2: pca@23 {
				compatible = "nxp,pca9535";
				reg = <0x23>;
				status = "okay";
				
				gpio-controller;
				#gpio-cells = <2>;
				
				gpio-line-names =
				"P0",
				"P1",
				"P2",
				"P3",
				"P4",
				"P5",
				"P6",
				"P7",
				"485_1_120R_EN",
				"485_2_120R_EN",
				"CAN_120R_EN",
				"P13",
				"P14",
				"P15",
				"P16",
				"P17"
				;
				
				485_1_120R_EN {
					gpios = <&pca9535_2 8 0>;
					output-high;
					line-name = "485_1_120R_EN";
				};
				
				485_2_120R_EN {
					gpios = <&pca9535_2 9 0>;
					output-high;
					line-name = "485_2_120R_EN";
				};
				
				CAN_120R_EN {
					gpios = <&pca9535_2 10 0>;
					output-high;
					line-name = "CAN_120R_EN";
				};
			};
		};
	};
	
	fragment@3 {
		target = <&i2c2>;
		__overlay__ {
			status = "okay";
			pinctrl-0 = <&rp1_i2c2_12_13>;
			pinctrl-names = "default";
			#address-cells = <1>;
			#size-cells = <0>;
			
			pca9554: pca@38 {
				compatible = "nxp,pca9554";
				reg = <0x38>;
				status = "okay";
				
				gpio-controller;
				#gpio-cells = <2>;
				
				gpio-line-names =
				"M2B_POWER_OFF",
				"M2B_W_DISABLE1",
				"M2B_DPR_3V3",
				"M2B_W_DISABLE2",
				"SIM_MUX_SEL",
				"M2B_PCIe_Reset_3V3"
				;
				
				M2B_POWER_OFF {
					gpios = <&pca9554 0 0>;
					output-high;
					line-name = "M2B_POWER_OFF";
				};
				
				M2B_W_DISABLE1 {
					gpios = <&pca9554 1 0>;
					output-low;
					line-name = "M2B_W_DISABLE1";
				};
				
				M2B_DPR_3V3 {
					gpios = <&pca9554 2 0>;
					output-high;
					line-name = "M2B_DPR_3V3";
				};
				
				M2B_W_DISABLE2 {
					gpios = <&pca9554 3 0>;
					output-high;
					line-name = "M2B_W_DISABLE2";
				};
				
				SIM_MUX_SEL {
					gpios = <&pca9554 4 0>;
					output-high;
					line-name = "SIM_MUX_SEL";
				};
				
				M2B_PCIe_Reset_3V3 {
					gpios = <&pca9554 5 0>;
					output-low;
					line-name = "M2B_PCIe_Reset_3V3";
				};
			};
		};
	};
	
	fragment@4 {
		target = <&i2c3>;
		__overlay__ {
			status = "okay";
			pinctrl-0 = <&rp1_i2c3_22_23>;
			pinctrl-names = "default";
			#address-cells = <1>;
			#size-cells = <0>;
		};
	};
	
	fragment@5 {
		target-path="/";
		__overlay__ {
			beeper: beeper {
				compatible = "gpio-beeper";
				gpios = <&pca9535_1 3 0>;
				status = "okay";
			};
		};
	};
	
	fragment@6 {
		target = <&leds>;
		__overlay__ {
			compatible = "gpio-leds";
			led_red: led_red {
				label = "led-red";
				linux,default-trigger = "default-off";
				gpios = <&pca9535_1 7 0>;
				default-state = "off";
			};
			
			led_green: led_green {
				label = "led-green";
				linux,default-trigger = "default-off";
				gpios = <&pca9535_1 6 0>;
				default-state = "off";
			};
			
			led_blue: led_blue {
				label = "led-blue";
				linux,default-trigger = "default-off";
				gpios = <&pca9535_1 5 0>;
				default-state = "off";
			};
		};
	};
	
	fragment@7 {
		target = <&pciex1>;
		__overlay__ {
			max-link-speed = <3>;
			status = "okay";
		};
	};
	
	fragment@8 {
		target = <&uart0>;
		__overlay__ {
			status = "okay";
		};
	};
	
	fragment@9 {
		target = <&gpio>;
		__overlay__ {
			spi2_cs_pins: spi2_cs_pins {
				functions = "spi2";
				pins = "gpio0", "gpio24";
				bias-pull-up;
			};
		};
	};
	
	fragment@10 {
		target = <&spi2>;
		__overlay__ {
			status = "okay";
			pinctrl-names = "default";
			pinctrl-0 = <&rp1_spi2_gpio1 &spi2_cs_pins>;
			cs-gpios = <&gpio 0 1>, <&gpio 24 1>;
			
			#address-cells = <1>;
			#size-cells = <0>;
			
			spidev_frag: spidev@0 {
				compatible = "spidev";
				reg = <0>;      /* CE0 */
				#address-cells = <1>;
				#size-cells = <0>;
				spi-max-frequency = <125000000>;
				status = "okay";
			};
			
			slb9670: slb9670@1 {
				compatible = "infineon,slb9670";
				reg = <1>;  /* CE1 */
				#address-cells = <1>;
				#size-cells = <0>;
				spi-max-frequency = <12500000>;
				status = "okay";
			};
		};
	};
	
	fragment@11 {
		target-path = "/clocks";
		__overlay__ {
			/* external 40M oscillator of mcp2518fd on SPI3.0 */
			mcp2518fd_osc: mcp2518fd_osc {
				compatible = "fixed-clock";
				#clock-cells = <0>;
				clock-frequency  = <40000000>;
			};
		};
	};
	
	fragment@12 {
		target = <&gpio>;
		__overlay__ {
			can_int_pins: can_int_pins {
				brcm,pins = <8>;
				brcm,function = <0>; /* input */
			};

            spi3_cs_pins: spi3_cs_pins {
                functions = "spi3";
                pins = "gpio4", "gpio25";
                bias-pull-up;
            };
		};
	};
	
	fragment@13 {
		target = <&spi3>;
		__overlay__ {
			status = "okay";
			pinctrl-names = "default";
			pinctrl-0 = <&rp1_spi3_gpio5 &spi3_cs_pins>;
			cs-gpios = <&gpio 4 1>, <&gpio 25 1>;
			
			#address-cells = <1>;
			#size-cells = <0>;
			
			can0: can0@0 {
				reg = <0>;
				pinctrl-names = "default";
				pinctrl-0 = <&can_int_pins>;
				compatible = "microchip,mcp251xfd";
				spi-max-frequency = <20000000>;
				interrupt-parent = <&gpio>;
				interrupts = <8 8>; /* IRQ_TYPE_LEVEL_LOW */
				clocks = <&mcp2518fd_osc>;
			};
		};
	};
	
	fragment@14 {
		target = <&i2s_clk_consumer>;
		__overlay__ {
			status = "okay";
		};
	};
	
	fragment@15 {
		target-path="/";
		__overlay__ {
			tlv320aic3104_mclk: tlv320aic3104_mclk {
				#clock-cells = <0>;
				compatible = "fixed-clock";
				clock-frequency = <24576000>;
			};
		};
	};
	
	fragment@16 {
		target = <&sound>;
		slave_overlay: __overlay__ {
			compatible = "simple-audio-card";
			simple-audio-card,format = "i2s";
			simple-audio-card,name = "seeed2micvoicec";
			i2s-controller = <&i2s_clk_consumer>;
			status = "okay";
			
			simple-audio-card,widgets =
			"Headphone", "Headphone Jack",
			"Line", "Line In";
			simple-audio-card,routing =
			"Headphone Jack", "HPLOUT",
			"Headphone Jack", "HPROUT",
			"MIC2L",         "Line In",
			"MIC2R",         "Line In";
			
			simple-audio-card,bitclock-master = <&sound_master>;
			simple-audio-card,frame-master = <&sound_master>;
			
			simple-audio-card,cpu {
				sound-dai = <&i2s_clk_consumer>;
			};
			sound_master: simple-audio-card,codec {
				#sound-dai-cells = <0>;
				sound-dai = <&tlv320aic3104>;
				clocks = <&tlv320aic3104_mclk>;
				clock-names = "mclk";
			};
		};
	};

	fragment@17 {
		target-path="/";
		__overlay__ {
			gpio_pse_int: gpio-pse-int {
				compatible = "gpio-keys";
				status = "okay";
				pse_intb: pse-intb {
					label = "pse-intb";
					linux,code = <116>;
					gpios = <&pca9535_1 1 GPIO_ACTIVE_LOW>;
				};
			};
		};
	};
};
